<!DOCTYPE html>
 <head>
        <link rel="stylesheet" href="style.css" type="text/css"/>

        <meta charset="UTF-8">
        <title>Debuter la Consultation</title>
        <!-- Librairie Javascript: jQuery (v3.4.1) -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    </head>
    
    <header>
         <div class="top-buttons">
            <button type="button" class = "hvr-shrink" id="button-retour" onclick="window.location.href='./tableauBordEmploye.html'">Retour au tableau de bord</button>
            <button type="button" class = "hvr-shrink" id="button-deconnecter">Se Déconnecter</button>
          </div>
          <div class="container-header">
            <div class="logo-header"></div>
            <h1>PREDICT'IF</h1>
          </div>
    </header>
    <body>
        
        <div class="title-emp">
            <h1>Débuter la Consultation</h1>
        </div>
        
        <div class="empConsultation-container">
            <div class="empConsultation-infoClient">
                <h2 class="sous-titre">Informations du Client</h2>
                    <p><strong>Nom :</strong> <span id="champ-nom"></span></p>
                    <p><strong> Date de Naissance :</strong> <span id="champ-date"></span></p>
                    <p><strong>Signe du zodiaque :</strong> <span id="champ-zodiaque"></span></p>
                    <p><strong>Signe astrologique chinois :</strong> <span id="champ-chinois"></span></p>
                    <p><strong>Couleur porte-bonheur :</strong> <span id="champ-couleur"></span></p>
                    <p id="last"><strong>Animal totem :</strong> <span id="champ-totem"></span></p>
            </div>
            <div class="empConsultation-sub-container">
                <div class="empConsultation-historique">
                    <div class="empConsultation-historique-titre">
                        <button id="button-precedent">Précedent</button>
                        <h2 class="sous-titre">Historique du Client</h2>
                        <button id="button-suivant">Suivant</button>
                    </div>
                    <div class="empConsultation-historique-date">
                        <p>Le <span id="champ-dateConsultation"></span></p>
                        <p> Medium: <span id="champ-medium"></span></p>
                        <p> Durée:<span id="champ-duree"></span></p>
                    </div>
                    <p id="text-commentaire">Commentaire : </p>
                    <div class="empConsultation-historique-commentaire">
                        <p id="champ-commentaire">
                        </p>
                    </div>
                </div>
                <div class="empConsultation-begin">
                    Consultation le: <span id="champ-beginConsultation"></span>
                    <button id="button-commencer-consultation"> Commencer la consultation</button> 
                </div>
                <div class="empConsultation-enCours">
                    <h2 class="sous-titre">Aide à la prédiction</h2>
                </div>
            </div>
            <div class="empConsultation-commentaire">
                
            </div>
        </div>
        <script>
            //Variables Globales
            var Consultations; //liste des consultations
            var idClient=null;
            var idConsultation=null;
            var viewedConsultation=0;
            var nbConsultations;
            
             // URL Parser --> Récupération des paramètres GET
            var parseQueryString = function() {
                var str = window.location.search;
                var objURL = {};
                str.replace(
                    new RegExp( "([^?=&]+)(=([^&]*))?", "g" ),
                    function( $0, $1, $2, $3 ){
                        objURL[ $1 ] = $3;
                    }
                );
                return objURL;
            };
    
            function initProfilAstral() { // Fonction appelée lors du clic sur le bouton
                // Appel AJAX
                let id=idClient;
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'profilAstral',
                        idClient:id
                    },
                    dataType: 'json'
                })
                .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                    var profil = response.profilAstral;
                    $('#champ-nom').html(response.prenom+" "+response.nom);
                    $('#champ-date').html(response.dateNaissance);
                    $('#champ-zodiaque').html(profil.zodiaque);
                    $('#champ-chinois').html(profil.astroChinois);
                    $('#champ-couleur').html(profil.couleur);
                    $('#champ-totem').html(profil.animalTotem);
                })
                .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                    console.log('Error',error); // LOG dans Console Javascript
                    alert("Erreur lors de l'appel AJAX");
                });
            };
            
            
            function listeConsultation() { // Fonction appelée lors du clic sur le bouton
                // Appel AJAX
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'historiqueClient',
                        idClient:idClient,
                        commentaire:true
                    },
                    dataType: 'json'
                })
                .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                    Consultations = response.consultations;
                    nbConsultations=Consultations.length;
                    AfficherConsultation();
                })
                .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                    console.log('Error',error); // LOG dans Console Javascript
                    alert("Erreur lors de l'appel AJAX");
                });
            };
            
            function detailConsultation() { // Fonction appelée lors du clic sur le bouton
                // Appel AJAX
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'detailsConsultation',
                        commentaire: false,
                        id:idConsultation
                    },
                    dataType: 'json'
                })
                .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                    var consultation = response.consultation;
                    console.log(consultation);
                    if(consultation != null)
                    {
                       $('#champ-beginConsultation').html(consultation.dateDebut);
                    }
                })
                .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                    console.log('Error',error); // LOG dans Console Javascript
                    alert("Erreur lors de l'appel AJAX");
                });
            };
            
            function AfficherConsultation(){
                if(nbConsultations!=0){
                        $('#champ-dateConsultation').html(Consultations[viewedConsultation].dateDebut);
                        $('#champ-medium').html(Consultations[viewedConsultation].medium.denomination);
                        $('#champ-duree').html(" "+Consultations[viewedConsultation].duree+" min");
                        $('#champ-commentaire').html("\" "+Consultations[viewedConsultation].commentaire+" \"");
                    }
                else{
                    $('#champ-commentaire').html("Ce client n'a pas d'historique de Consultation");
                }
            }
            
            function CommencerConsultation(){
              $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'commencerConsultation',
                        id:idConsultation
                    },
                    dataType: 'json'
                })
                .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                   console.log(response);
                    AffichageMode2();
                })
                .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                    console.log('Error',error); // LOG dans Console Javascript
                    alert("Erreur lors de l'appel AJAX");
                });  
            };
            
            function AffichageMode1(){
                $('.empConsultation-enCours').css({display:'none'});
                $('.empConsultation-begin').css({
                    display:'flex',
                    'justify-content': 'space-between',
                    padding:'20px',
                    border:'2px solid black',
                    width:'100%'
                });
                $('#button-retour').html("Retour au Tableau de Bord");
                $('#button-retour').attr("onclick","window.location.href='./tableauBordEmploye.html'");
            }
            
            function AffichageMode2(){
                $('.empConsultation-begin').css({display:'none'});
                $('.empConsultation-enCours').css({
                    display:'flex',
                    'flex-direction':'column',
                    'justify-content': 'space-between',
                    padding:'20px',
                    border:'2px solid black',
                    width:'100%'
                });
                $('#button-retour').html("Annuler le début de consultation");
                $('#button-retour').attr("onclick","AffichageMode1()");
            }
            
            
            function Deconnecter(){
                $.ajax({
                    url: './ActionServlet',
                    method: 'POST',
                    data: {
                        todo: 'deconnecter'
                    },
                    dataType: 'json'
                })
                .done( function (response) { // Fonction appelée en cas d'appel AJAX réussi
                   window.location.href='./login.html';
                })
                .fail( function (error) { // Fonction appelée en cas d'erreur lors de l'appel AJAX
                    console.log('Error',error); // LOG dans Console Javascript
                    alert("Erreur lors de l'appel AJAX");
                });
            };
            
            function ConsultationSuivante(page){
                console.log(page);
                if(nbConsultations!=0){
                    viewedConsultation+=page;
                    if(viewedConsultation>=nbConsultations){
                        viewedConsultation=0;
                    }
                    if(viewedConsultation<0){
                        viewedConsultation=nbConsultations-1;
                    }
                    AfficherConsultation;
                }
            }
            
             $(document).ready( function () {
                 idClient=parseQueryString()["id"];
                 idConsultation=parseQueryString()["consultation"];
                 parseQueryString()["date"];
                 initProfilAstral();
                 listeConsultation();
                 detailConsultation();
                 $('#button-deconnecter').on('click',Deconnecter);
                 $('#button-suivant').on('click',function(){ConsultationSuivante(1);});
                 $('#button-precedent').on('click',function(){ConsultationSuivante(-1);});
                 $('#button-commencer-consultation').on('click',CommencerConsultation);
             });
        </script>
                 
        
    </body>
</html>
